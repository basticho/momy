#!/bin/bash

SERVER="localhost:3000"
POSTURL="$SERVER/saveLog"
LOGFILE="./log"
USER="goferito"
DEVICE="laptinux"
CHECKTIME="5"
#source /usr/share/momy/conf;

function lateDownTime {
    last=`tail -1 $LOGFILE | grep "SYSTEM DOWN"`;
    if [ -n "$last" ]; then
        sed '$d' < $LOGFILE > tmp;
        mv tmp $LOGFILE;
    fi
    echo `date +[%Y-%m-%d\ %H:%M:%S]` "SYSTEM DOWN" >> $LOGFILE;
}

function postLog {
    log=`cat $LOGFILE`;
    res=0;
    while [ "$res" != "BRAVO" ]
    do
        echo "Posting..."
        res=`wget --post-data "$log" -O - -q $POSTURL`
        if [ "$res" != "BRAVO" ]; then
            echo "Error posting.";
            sleep 30;
        fi
    done
    echo "Log sent: $log"
    #log should now be deleted, except for the lines with current session.
}

if [ "$1" = "stop" ];
then
        lateDownTime;
        exit;
fi

if [ "$1" = "start" ];
then
	#Save the access in the log
    echo `date +[%Y-%m-%d\ %H:%M:%S]` "SYSTEM UP" >> $LOGFILE;

    #Keep notifing the system is up every CHECKTIME
    while true
    do
        lateDownTime;
        postLog;
        sleep $CHECKTIME;
    done
fi

