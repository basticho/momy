#!/bin/bash

SERVER="localhost:4532"
POSTURL="$SERVER/saveLog"
LOGFOLDER="/tmp"
LOGFILE="$LOGFOLDER/momyLog"
GRASSFOLDER="/usr/share/momy"
GRASSLOG="$GRASSFOLDER/log"
USER="goferito"
DEVICE="laptinux"
CHECKTIME="20"
#source ./conf;

function lateDownTime {
    last=`tail -1 $LOGFILE | grep "SYSTEM DOWN"`;
    if [ -n "$last" ]; then
        sed '$d' < $LOGFILE > "$LOGFOLDER/tmpmomy";
        mv "$LOGFOLDER/tmpmomy" $LOGFILE;
    fi
    echo `date +[%Y-%m-%d\ %H:%M:%S]` "SYSTEM DOWN" >> $LOGFILE;
    echo "DownTime updated."
}

function postLog {
    log=`cat $LOGFILE`;
    res=0;
    echo "Sending log..."
    res=`wget --post-data "user=$USER&device=$DEVICE&log=$log" -O - -q $POSTURL`
    if [ "$res" != "BRAVO" ]; then
        echo "Error posting.";
        echo `date +[%Y-%m-%d\ %H:%M:%S]` "ERROR POSTING" >> $GRASSLOG;
    else
        echo "Log sent:"
        echo -e $log
        #log should now be deleted, except for the lines with current session.
        cat $LOGFILE | tail -2 > "$LOGFOLDER/tmpMomyLog";
        mv "$LOGFOLDER/tmpMomyLog" $LOGFILE
        echo "Log purged."
    fi
}

if [ "$1" = "stop" ];
then
        lateDownTime;
        exit;
fi

if [ "$1" = "start" ];
then
	#Save the access in the log
    echo `date +[%Y-%m-%d\ %H:%M:%S]` "SYSTEM UP" >> $LOGFILE;

    #Keep notifing the system is up every CHECKTIME
    while true
    do
        lateDownTime;
        postLog;
        sleep $CHECKTIME;
    done
fi

