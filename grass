#!/bin/bash

SERVER="localhost:4532"
POSTURL="$SERVER/saveLog"
LOGFOLDER="/tmp"
LOGFILE="$LOGFOLDER/momyLog"
#LOGFILE="./log"
USER="goferito"
DEVICE="laptinux"
CHECKTIME="20"
#source ./conf;

function lateDownTime {
    last=`tail -1 $LOGFILE | grep "SYSTEM DOWN"`;
    if [ -n "$last" ]; then
        sed '$d' < $LOGFILE > tmp;
        mv tmp $LOGFILE;
    fi
    echo `date +[%Y-%m-%d\ %H:%M:%S]` "SYSTEM DOWN" >> $LOGFILE;
    echo "DownTime updated."
}

function postLog {
    log=`cat $LOGFILE`;
    res=0;
    while [ "$res" != "BRAVO" ]
    do
        echo "Sending log..."
        res=`wget --post-data "user=$USER&device=$DEVICE&log=$log" -O - -q $POSTURL`
        if [ "$res" != "BRAVO" ]; then
            echo "Error posting.";
            sleep $CHECKTIME;
        fi
    done
    echo "Log sent:"
    echo -e $log
    #log should now be deleted, except for the lines with current session.
    cat $LOGFILE | tail -2 > tmpLog;
    mv tmpLog $LOGFILE
    echo "Log purged."
}

if [ "$1" = "stop" ];
then
        lateDownTime;
        exit;
fi

if [ "$1" = "start" ];
then
	#Save the access in the log
    echo `date +[%Y-%m-%d\ %H:%M:%S]` "SYSTEM UP" >> $LOGFILE;

    #Keep notifing the system is up every CHECKTIME
    while true
    do
        lateDownTime;
        postLog;
        sleep $CHECKTIME;
    done
fi

